<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼‚Â·æ¡ƒèŠ±æºï¼šå¤§è’è¯¡äº‹å½• (V13.0)</title>
    <style>
        /* ==================== 1. æ ¸å¿ƒè§†è§‰ ==================== */
        @font-face {
            font-family: 'PixelFont';
            src: local('KaiTi'), local('STKaiti'), url('https://fonts.cdnfonts.com/s/14955/KaiTi.woff') format('woff');
        }

        :root {
            --bg-color: #1a0f0f;       
            --frame-border: #8d6e63;   
            --frame-dark: #3e2723;     
            --panel-bg: #4e342e;       
            --text-light: #efebe9;     
            --ap-color: #ffb74d;       
            --hp-color: #d32f2f;       
            --money-color: #29b6f6;    
        }

        body {
            margin: 0; background-color: #000; color: var(--text-light);
            font-family: 'PixelFont', serif;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            overflow: hidden; user-select: none;
        }

        .pixel-box {
            background: var(--panel-bg);
            border: 4px solid transparent;
            border-image: linear-gradient(to bottom right, var(--frame-border), var(--frame-dark)) 1;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            position: relative;
        }

        #game-root {
            width: 1280px; height: 720px;
            background: var(--bg-color);
            border: 2px solid #3e2723;
            display: grid;
            grid-template-columns: 260px 1fr 380px;
            grid-template-rows: 70px 1fr;
            gap: 8px; padding: 8px;
            box-shadow: 0 0 80px rgba(0,0,0,1);
            max-height: 100vh; box-sizing: border-box;
        }

        /* ==================== 2. é¡¶éƒ¨æ  ==================== */
        #top-bar {
            grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; background: #3e2723; border-bottom: 2px solid #5d4037;
        }
        .status-group { display: flex; gap: 20px; align-items: center; }
        .bar-container { width: 100px; display: flex; flex-direction: column; gap: 2px; }
        .progress-track { width: 100%; height: 6px; background: #221111; border: 1px solid #6d4c41; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        
        #hp-container { display: flex; gap: 4px; font-size: 28px; color: #d32f2f; text-shadow: 0 0 5px black; cursor: help;}
        .heart.lost { color: #3e2723; text-shadow: none; transform: scale(0.8); }

        .btn-group-top { display: flex; gap: 10px; }
        .top-btn {
            background: #1a237e; color: #fff; border: 1px solid #5c6bc0;
            padding: 5px 15px; cursor: pointer; font-family: inherit; font-size: 14px;
            display: flex; align-items: center; gap: 5px; box-shadow: 0 0 5px #000;
            border-radius: 4px; transition: transform 0.1s;
        }
        .top-btn:hover { transform: scale(1.05); }
        .btn-leave { background: #b71c1c; border-color: #ef5350; }

        /* ==================== 3. å·¦ä¾§é¢æ¿ ==================== */
        #left-panel { grid-row: 2; grid-column: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tab-header { display: flex; gap: 2px; margin-bottom: 5px; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 10px 0; text-align: center; background: #3e2723; color: #a1887f; cursor: pointer; border: 1px solid #5d4037; font-weight: bold; }
        .tab-btn.active { background: #5d4037; color: #fff; border-bottom: none; box-shadow: inset 0 0 5px #000; }

        #inventory-grid { 
            flex: 1; padding: 10px; display: none; grid-template-columns: repeat(3, 1fr); gap: 6px; 
            grid-auto-rows: 70px; overflow-y: auto; background: rgba(0,0,0,0.2); 
        }
        .item-slot { 
            background: #3e2723; border: 2px inset #2d1b1b; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; transition: all 0.2s;
        }
        .item-slot.selected { border-color: gold; background: #5d4037; box-shadow: 0 0 5px gold; }
        .item-name-tag { font-size: 10px; margin-top: 2px; color: #ccc; width:90%; overflow:hidden; white-space:nowrap; text-align:center;}
        .item-count { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.8); color: #fff; font-size: 10px; padding: 1px 4px; }

        #relation-list { flex: 1; padding: 10px; overflow-y: auto; display: none; background: rgba(0,0,0,0.2); }
        .rel-card {
            background: #3e2723; border-bottom: 1px solid #5d4037; padding: 10px; 
            display: flex; justify-content: space-between; align-items: center; font-size: 14px;
        }
        .rel-val { font-weight: bold; }
        .rel-val.high { color: #66bb6a; }
        .rel-val.low { color: #ef5350; }

        #item-menu {
            position: absolute; background: #212121; border: 2px solid #8d6e63;
            display: none; flex-direction: column; z-index: 100; box-shadow: 0 5px 15px black; width: 140px;
        }
        .item-menu-btn { padding: 10px; cursor: pointer; color: white; border-bottom: 1px solid #424242; font-size: 14px; text-align: center; }
        .item-menu-btn:hover { background: #424242; color: gold; }

        /* ==================== 4. ä¸­é—´ç”»é¢ ==================== */
        #main-view {
            grid-row: 2; grid-column: 2; position: relative; background: #000; overflow: hidden;
            border: 2px solid #000; transition: box-shadow 0.3s;
        }
        #scene-bg { width: 100%; height: 100%; object-fit: cover; transition: filter 2s; }
        
        .npc-entity {
            position: absolute; display: flex; flex-direction: column; align-items: center; 
            cursor: pointer; z-index: 10; transition: transform 0.2s;
        }
        .npc-entity:hover { transform: scale(1.05); z-index: 20; }
        .npc-sprite { width: 100px; height: 160px; object-fit: contain; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); mix-blend-mode: multiply;}
        
        .npc-fallback { width: 50px; height: 90px; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .npc-label { background: rgba(0,0,0,0.8); color: #fff; padding: 2px 6px; font-size: 12px; border-radius: 4px; margin-top: -10px; z-index: 25; white-space: nowrap; border: 1px solid #aaa; }

        #danger-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: red; opacity: 0; pointer-events: none; z-index: 1500;
            transition: opacity 0.5s; mix-blend-mode: overlay;
        }

        #loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); display: none;
            justify-content: center; align-items: center; color: #d00; font-size: 24px; letter-spacing: 2px;
            z-index: 2200; text-shadow: 0 0 10px red;
        }

        /* å•†åº—ç•Œé¢ */
        #shop-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 600px; height: 450px; background: #3e2723; border: 4px ridge #d7ccc8;
            z-index: 2000; display: none; flex-direction: column; padding: 10px;
            box-shadow: 0 0 50px #000;
        }
        .shop-tabs { display: flex; border-bottom: 2px solid #5d4037; margin-bottom: 10px; }
        .shop-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #a1887f; font-weight: bold; }
        .shop-tab.active { background: #5d4037; color: gold; }
        
        #shop-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .shop-item { background: #2d1b1b; border: 1px solid #5d4037; padding: 5px; text-align: center; cursor: pointer; font-size: 12px; position:relative; }
        .shop-item:hover { border-color: gold; }
        
        /* è®¨ä»·è¿˜ä»·é¢æ¿ */
        #haggle-panel {
            display: none; flex-direction: column; gap: 10px; padding: 10px; background: #221;
            border: 1px solid #554; margin-top: 10px;
        }
        #haggle-input { width: 90%; padding: 8px; background: #332; border: 1px solid #554; color: white; }

        /* åŒ—æ–¹ç¦åœ° */
        #north-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(10, 0, 0, 0.95); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 2100;
            border: 4px solid #b71c1c;
        }
        .ghost-card {
            width: 300px; padding: 30px; background: #3e2723; border: 2px solid #ff5252;
            text-align: center; margin-bottom: 20px; box-shadow: 0 0 30px red;
        }
        .ghost-title { font-size: 30px; color: #ff5252; margin-bottom: 10px; font-weight: bold; text-shadow: 0 0 10px black; }
        .ghost-desc { color: #bdbdbd; font-size: 16px; margin-bottom: 20px; line-height: 1.5; }
        .north-btn {
            width: 220px; padding: 15px; margin: 8px; cursor: pointer; font-size: 16px; font-weight: bold;
            background: #212121; border: 1px solid #757575; color: white; transition: all 0.2s;
        }
        .north-btn:hover { background: #b71c1c; border-color: white; transform: scale(1.05); }
        .north-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* ==================== 5. å³ä¾§å‰§æƒ… ==================== */
        #right-panel {
            grid-row: 2; grid-column: 3; background: #fdf6e3;
            display: flex; flex-direction: column; border: 4px solid #5d4037;
            height: 100%; overflow: hidden;
        }

        #log-area {
            flex: 1; min-height: 0; overflow-y: auto; padding: 20px;
            font-size: 15px; line-height: 1.6; color: #3e2723;
            background-image: linear-gradient(#e0e0e0 1px, transparent 1px); background-size: 100% 28px;
            scroll-behavior: smooth;
        }
        #log-area::-webkit-scrollbar { width: 8px; }
        #log-area::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 4px; }

        .log-item { margin-bottom: 15px; animation: fadeIn 0.3s; word-wrap: break-word; }
        .log-name { font-weight: 900; color: #bf360c; font-size: 16px; margin-right: 5px; }
        .log-sys { text-align: center; color: #5d4037; font-style: italic; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; font-size: 13px; margin: 10px 0; border: 1px solid #d7ccc8; }
        .log-danger { color: #b71c1c; border-color: #ef5350; background: #ffebee; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #action-bar {
            padding: 10px; background: #efebe9; border-top: 2px dashed #b0bec5;
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
        }
        .act-btn {
            padding: 10px; cursor: pointer; border: 1px solid #bcaaa4; background: #fff;
            text-align: center; font-weight: bold; color: #3e2723; box-shadow: 0 2px 0 #d7ccc8;
        }
        .act-btn:hover { background: #fbe9e7; border-color: var(--accent); }

        #choice-area {
            flex-shrink: 0; background: #eceff1; padding: 10px;
            display: flex; flex-direction: column; gap: 5px; max-height: 200px; overflow-y: auto;
        }
        .btn-choice {
            background: #fff; border: 1px solid #cfd8dc; padding: 8px;
            cursor: pointer; color: #455a64; font-size: 13px;
            display: flex; justify-content: space-between;
        }
        .btn-choice:hover { background: #e0f7fa; color: #006064; }
        
        /* ç»“å±€ */
        #ending-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; color: #fff; z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            font-family: 'PixelFont', serif;
        }
        #ending-content { width: 60%; text-align: center; animation: fadeUp 3s ease-out; }
        #ending-title { font-size: 48px; color: #d32f2f; margin-bottom: 30px; letter-spacing: 5px; }
        #ending-text { font-size: 18px; line-height: 2; color: #ccc; margin-bottom: 50px; }
        #restart-btn {
            padding: 15px 40px; background: transparent; border: 2px solid #fff; color: #fff;
            font-size: 20px; cursor: pointer; transition: all 0.3s;
        }
        #restart-btn:hover { background: #fff; color: #000; }
        @keyframes fadeUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

        #start-mask {
            position: absolute; top:0; left:0; width:100%; height:100%; z-index: 9999;
            background: #1a1212; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="game-root">
    <div id="top-bar" class="pixel-box">
        <div class="status-group">
            <div id="hp-container" title="ç”Ÿå‘½å€¼ï¼šå½’é›¶æ­»äº¡"></div>
            <div class="bar-container">
                <div style="font-size:12px; color:#aaa;">ä½“åŠ› <span id="txt-ap">10.0</span></div>
                <div class="progress-track"><div id="bar-ap" class="progress-fill" style="width:100%; background:var(--ap-color);"></div></div>
            </div>
            <div class="bar-container">
                <div style="font-size:12px; color:#aaa;">ç†æ™º <span id="txt-san">100%</span></div>
                <div class="progress-track"><div id="bar-san" class="progress-fill" style="width:100%; background:#29b6f6;"></div></div>
            </div>
            <div class="info-tag" id="game-clock">ğŸ“… 547å¹´ | â˜€ ç™½æ˜¼</div>
            <div class="info-tag" style="color: gold; border-color: gold;">ğŸ’° <span id="txt-money">5</span> ä¸¤</div>
        </div>
        <div class="btn-group-top">
            <button class="top-btn" onclick="Game.goToInn()">ğŸ¨ ä½åº—</button>
            <button class="top-btn btn-leave" onclick="Game.triggerEnding('escape')">ğŸ”š ç¦»æ‘</button>
        </div>
    </div>

    <div id="left-panel" class="pixel-box">
        <div class="tab-header">
            <div class="tab-btn active" onclick="Game.switchTab('inventory')">è¡Œå›Š</div>
            <div class="tab-btn" onclick="Game.switchTab('relation')">äººé™…</div>
        </div>
        
        <div id="inventory-grid" style="display:grid;"></div>
        <div id="relation-list"></div>
        
        <div id="item-menu">
            <div class="item-menu-btn" onclick="Game.useItem()">ğŸ¤² ä½¿ç”¨</div>
            <div class="item-menu-btn" onclick="Game.askItem()">ğŸ’¬ è¯¢é—®NPC</div>
            <div class="item-menu-btn" onclick="document.getElementById('item-menu').style.display='none'">âŒ å–æ¶ˆ</div>
        </div>
    </div>

    <div id="main-view" class="pixel-box">
        <img id="scene-bg" src="" alt="èƒŒæ™¯">
        <div id="sprite-layer"></div>
        <div id="danger-overlay"></div>
        <div id="loading-overlay">DeepSeek æ­£åœ¨æ¨æ¼”å› æœ...</div>
        
        <div id="shop-modal">
            <div class="shop-tabs">
                <div class="shop-tab active" onclick="Game.switchShopTab('buy')">ğŸ’° å–µæŒæŸœçš„è´§æ¶</div>
                <div class="shop-tab" onclick="Game.switchShopTab('sell')">ğŸ“¦ æˆ‘è¦å–è´§(åšå¼ˆ)</div>
            </div>
            <div id="shop-grid"></div>
            <div id="haggle-panel">
                <div style="color:#aaa; font-size:12px;">è¿™å¯æ˜¯ä¸ªå¥¸å•†ï¼Œè¯´ç‚¹å¥½å¬çš„å¿½æ‚ ä»–...</div>
                <input type="text" id="haggle-input" placeholder="è¾“å…¥å¿½æ‚ è¯æœ¯ï¼Œå¦‚ï¼šè¿™å¯æ˜¯ç§¦å§‹çš‡ç”¨è¿‡çš„ï¼">
                <div style="display:flex; justify-content:space-between;">
                    <button class="inn-btn" onclick="Game.confirmSell()">å‡ºä»·!</button>
                    <button class="inn-btn" style="background:#5d4037" onclick="document.getElementById('haggle-panel').style.display='none'">å–æ¶ˆ</button>
                </div>
            </div>
            <button onclick="document.getElementById('shop-modal').style.display='none'" style="margin-top:auto;background:#d32f2f;color:white;border:none;padding:8px;">ç¦»å¼€é»‘åº—</button>
        </div>

        <div id="north-overlay">
            <div class="ghost-card">
                <div id="ghost-title" class="ghost-title">???</div>
                <div id="ghost-desc" class="ghost-desc">...</div>
                <div style="font-size:50px; margin:10px;">ğŸ‘»</div>
            </div>
            <div id="north-actions"></div>
        </div>
    </div>

    <div id="right-panel">
        <div id="log-area">
            <div class="log-item sys-msg">
                ç³»ç»Ÿï¼šæ¬¢è¿æ¥åˆ°å¤§è’ã€‚<br>åˆå§‹5ä¸¤é“¶å­ã€‚ç™½å¤©æ‰“å·¥è‡´å¯Œï¼Œå¤œæ™šå¤œå®´èµŒå‘½ã€‚<br>ä½“åŠ›è€—å°½è‡ªåŠ¨å¤©é»‘ã€‚
            </div>
        </div>
        <div id="action-bar" style="display:none;">
            <div class="act-btn" onclick="Game.handleAction('dine')">ğŸš å»å®¶åƒé¥­</div>
            <div class="act-btn" onclick="Game.handleAction('work')">ğŸ’ª æ‰“å·¥(èµšé’±)</div>
            <div class="act-btn" onclick="Game.handleAction('gift')">ğŸ é€ç¤¼</div>
            <div class="act-btn" onclick="Game.handleAction('shop')" id="btn-shop" style="display:none;">ğŸª äº¤æ˜“</div>
            <div class="act-btn" onclick="Game.handleAction('leave')" style="background:#ffebee; color:#c62828;">ğŸšª ç¦»å¼€</div>
        </div>
        <div id="choice-area"></div>
    </div>
</div>

<div id="ending-screen">
    <div id="ending-content">
        <div id="ending-title">ç»“å±€ç”Ÿæˆä¸­...</div>
        <div id="ending-text">DeepSeek æ­£åœ¨ä¹¦å†™ä½ çš„å‘½è¿...</div>
        <button id="restart-btn" onclick="location.reload()">å†å…¥è½®å›</button>
    </div>
</div>

<div id="start-mask">
    <h1 style="font-size: 64px; color: #d84315; margin-bottom: 20px; text-shadow: 0 0 20px red;">å¤§è’è¯¡äº‹å½•</h1>
    <div style="color:#aaa; margin-bottom:40px; font-size:18px;">V13.0 å•†ä¸šå¤§äº¨ç‰ˆ Â· å¥¸å•†/æ‰“å·¥/å¤œå®´</div>
    <button style="padding:15px 60px; font-size:24px; cursor:pointer; background:#bf360c; color:white; border:none; border-radius:4px; box-shadow: 0 0 10px red;" onclick="Game.init()">å…¥ å±€</button>
</div>

<script>
const CONFIG = {
    apiKey: "sk-1a70f2b33f484be2801aa793af08bf39",
    apiUrl: "https://api.deepseek.com/chat/completions",
    maxAP: 10,
    maxHP: 5
};

const ASSETS = {
    bg: { day: 'assets/bg/bg_village.png', night: 'assets/bg/bg_river.png' },
    npc: {
        chief: { day: 'assets/sprites/chief.png', night: 'assets/sprites/chief_scary.png' },
        scholar: { day: 'assets/sprites/scholar.png', night: 'assets/sprites/scholar_scary.png' },
        farmer: { day: 'assets/sprites/villager_farmer.png', night: 'assets/sprites/villager_farmer_scary.png' },
        child: { day: 'assets/sprites/villager_child.png', night: 'assets/sprites/villager_child_scary.png' },
        weaver: { day: 'assets/sprites/villager_weaver.png', night: 'assets/sprites/villager_weaver_scary.png' },
        elder: { day: 'assets/sprites/villager_elder.png', night: 'assets/sprites/villager_elder_scary.png' },
        innkeeper: { day: 'assets/sprites/000.png', night: 'assets/sprites/000.png' }
    }
};

// é“å…·åº“ (ä»·æ ¼ä¸ºåŸºç¡€ä»·)
const ITEM_DB = {
    // ç™½å¤©é“å…·
    'd1': { name: 'è’¸è–¯å—', price: 1, type: 'day', effect: s=>{s.ap+=2; return 'ä½“åŠ›+2'}, icon:'ğŸ¥”' },
    'd2': { name: 'éº¦éº¸é¥¼', price: 1, type: 'day', effect: s=>{s.ap+=2; return 'ä½“åŠ›+2'}, icon:'ğŸ˜' },
    'd3': { name: 'ç”˜è‰æ°´', price: 1, type: 'day', effect: s=>{s.sanity+=5; return 'ç†æ™º+5'}, icon:'ğŸµ' },
    'd4': { name: 'é‡è“å¹²', price: 1, type: 'day', effect: s=>{s.ap+=1; return 'ä½“åŠ›+1'}, icon:'ğŸ’' },
    'd5': { name: 'è–„è·ä¸¸', price: 2, type: 'day', effect: s=>{s.sanity+=10; return 'ç†æ™º+10'}, icon:'ğŸ¬' },
    'd6': { name: 'é»„ç²¾ç‰‡', price: 2, type: 'day', effect: s=>{s.hp+=1; return 'è¡€é‡+1'}, icon:'ğŸ ' },
    'd7': { name: 'æ¡‚èŠ±èŒ¶', price: 2, type: 'day', effect: s=>{s.sanity+=10; return 'ç†æ™º+10'}, icon:'ğŸŒ¼' },
    'd8': { name: 'çƒ¤åšæœ', price: 2, type: 'day', effect: s=>{s.ap+=3; return 'ä½“åŠ›+3'}, icon:'ğŸŒ°' },
    'd9': { name: 'ç±³æµ†', price: 2, type: 'day', effect: s=>{s.ap+=2; return 'ä½“åŠ›+2'}, icon:'ğŸ¥›' },
    'd10':{ name: 'æ¸…å¿ƒä¸¸', price: 2, type: 'day', effect: s=>{s.sanity+=15; return 'ç†æ™º+15'}, icon:'ğŸ’Š' },
    'd11':{ name: 'ç³¯ç±³ç³', price: 3, type: 'day', effect: s=>{s.ap+=4; return 'ä½“åŠ›+4'}, icon:'ğŸ™' },
    'd12':{ name: 'èŒ¯è‹“ç³•', price: 3, type: 'day', effect: s=>{s.hp+=1; s.sanity+=5; return 'è¡€+1 ç†æ™º+5'}, icon:'ğŸ°' },
    'd13':{ name: 'æ —ä»',   price: 3, type: 'day', effect: s=>{s.ap+=3; return 'ä½“åŠ›+3'}, icon:'ğŸŒ°' },
    'd14':{ name: 'é‡‘åˆ›è¯', price: 3, type: 'day', effect: s=>{s.hp+=2; return 'è¡€é‡+2'}, icon:'ğŸº' },
    'd15':{ name: 'ç”œè±†ç³•', price: 3, type: 'day', effect: s=>{s.ap+=4; return 'ä½“åŠ›+4'}, icon:'ğŸ©' },

    // å¤œæ™šé“å…·
    'n1': { name: 'é•‡é­‚ç³–', price: 1, type: 'night', effect: s=>{s.sanity+=10; return 'ç†æ™º+10'}, icon:'ğŸ¬' },
    'n2': { name: 'å‡€çµéœ²', price: 2, type: 'night', effect: s=>{s.sanity+=20; s.hp-=1; return 'ç†æ™º+20 è¡€-1'}, icon:'ğŸ’§' },
    'n3': { name: 'é©±é‚ªç³•', price: 1, type: 'night', effect: s=>{s.sanity+=10; return 'ç†æ™º+10'}, icon:'ğŸ®' },
    'n4': { name: 'é¿ç¥Ÿä¸¸', price: 2, type: 'night', effect: s=>{s.sanity+=20; return 'ç†æ™º+20'}, icon:'ğŸŒ‘' },
    'n5': { name: 'å®‰é­‚ç³•', price: 3, type: 'night', effect: s=>{s.sanity+=30; return 'ç†æ™º+30'}, icon:'ğŸ°' },
    'n6': { name: 'ç ´ç…æ°´', price: 2, type: 'night', effect: s=>{s.sanity+=25; s.hp-=1; return 'ç†æ™º+25 è¡€-1'}, icon:'ğŸ¶' },
    'n7': { name: 'ç¼šçµç³•', price: 3, type: 'night', effect: s=>{s.sanity+=30; s.hp-=1; return 'ç†æ™º+30 è¡€-1'}, icon:'ğŸ™' },
    'n8': { name: 'æ¸…ç§½ä¸¸', price: 2, type: 'night', effect: s=>{s.sanity+=20; return 'ç†æ™º+20'}, icon:'ğŸ’Š' },
    'n9': { name: 'é•‡é‚ªè±†', price: 1, type: 'night', effect: s=>{s.sanity+=10; return 'ç†æ™º+10'}, icon:'ğŸ«˜' },
    'n10':{ name: 'é€šçµç³•', price: 3, type: 'night', effect: s=>{s.sanity+=40; s.hp-=2; return 'ç†æ™º+40 è¡€-2'}, icon:'ğŸ©' },
    'n11':{ name: 'ç¥›é˜´æ°´', price: 2, type: 'night', effect: s=>{s.sanity+=20; return 'ç†æ™º+20'}, icon:'ğŸ§‰' },
    'n12':{ name: 'æŠ¤é­‚ç³–', price: 1, type: 'night', effect: s=>{s.sanity+=10; return 'ç†æ™º+10'}, icon:'ğŸ­' },
    'n13':{ name: 'å¹³ç¥Ÿç³•', price: 3, type: 'night', effect: s=>{s.sanity+=30; return 'ç†æ™º+30'}, icon:'ğŸ§' },
    'n14':{ name: 'å‡€é­„éœ²', price: 2, type: 'night', effect: s=>{s.sanity+=25; return 'ç†æ™º+25'}, icon:'ğŸ§ª' },
    'n15':{ name: 'é¿å‡¶ä¸¸', price: 3, type: 'night', effect: s=>{s.sanity+=35; return 'ç†æ™º+35'}, icon:'ğŸ”®' },
    
    'relic_eye': { name: 'é˜´é˜³çœ¼', icon: 'ğŸ§¿', price:100, type: 'relic', desc: 'ã€é—ç‰©ã€‘çœ‹ç©¿è°è¨€ã€‚' },
    'relic_doll': { name: 'æ›¿æ­»è‰äºº', icon: 'ğŸ', price:100, type: 'relic', desc: 'ã€é—ç‰©ã€‘æŠµæŒ¡ä¸€æ¬¡æ­»äº¡ã€‚' }
};

const NORTH_GHOSTS = [
    { name: "è¿·è·¯ä¹¦ç«¥", type: "good", demand: "d1", demandName: "è’¸è–¯å—", reward: "relic_eye", desc: "æ§ç€æ— å­—å¤©ä¹¦å“­æ³£ã€‚", succ: "ä¹¦ç«¥åƒäº†ä¸œè¥¿ï¼Œé€ä½ ä¸€åªçœ¼ç›..." },
    { name: "çº¢è¡£æ–°å¨˜", type: "evil", demand: "n1", demandName: "é•‡é­‚ç³–", reward: "relic_doll", desc: "æ²¡æœ‰è„¸çš„æ–°å¨˜ã€‚", succ: "æ–°å¨˜å‘å‡ºä¸€å£°å°–ç¬‘..." },
    { name: "æ— å¤´å°†å†›", type: "evil", demand: "d14", demandName: "é‡‘åˆ›è¯", reward: "relic_doll", desc: "è„–é¢ˆå†’ç€é»‘çƒŸã€‚", succ: "å°†å†›æ‹¿èµ°äº†è¯..." }
];

const NPC_DB = [
    { id: 'elder', name: 'é˜¿å…¬', x: 20, y: 400, w: 110, color:'#9e9e9e', role_day:"çå­", role_night:"æ•£éª¨", affinity: 15, dining_count: 0 },
    { id: 'scholar', name: 'è€å…ˆç”Ÿ', x: 130, y: 380, w: 120, color:'#1a237e', role_day:"å…ˆç”Ÿ", role_night:"æ¯éª¨", affinity: 5, dining_count: 0 },
    { id: 'child', name: 'å°çŸ³å¤´', x: 230, y: 420, w: 90, color:'#f06292', role_day:"å­©ç«¥", role_night:"çº¸äºº", affinity: 20, dining_count: 0 },
    { id: 'chief', name: 'æ‘é•¿', x: 320, y: 350, w: 140, color:'#5d4037', role_day:"æ‘é•¿", role_night:"é¥•é¤®", affinity: 10, dining_count: 0 },
    { id: 'farmer', name: 'é˜¿ç‰›', x: 420, y: 380, w: 130, color:'#2e7d32', role_day:"å†œå¤«", role_night:"è¡Œå°¸", affinity: -5, dining_count: 0 },
    { id: 'weaver', name: 'ç»‡å¨˜', x: 500, y: 360, w: 120, color:'#c2185b', role_day:"ç»£å¨˜", role_night:"å‰¥çš®é¬¼", affinity: 0, dining_count: 0 },
    { id: 'innkeeper', name: 'å–µæŒæŸœ', x: 530, y: 260, w: 120, color:'#fbc02d', role_day:"æŒæŸœ", role_night:"çŒ«å¦–", affinity: -20, dining_count: 0 }
];

const Game = {
    state: {
        hp: 5, ap: 10.0, money: 5, sanity: 100, day: 1, isNight: false,
        inventory: [{ id: 'd1', count: 2 }],
        currentNpc: null,
        selectedItemIdx: -1,
        history: [],
        shopMode: 'buy', // buy or sell
        currentSellItem: null,
        journal: [] // ç»“å±€æ—¥è®°
    },

    init: function() {
        document.getElementById('start-mask').style.display = 'none';
        this.renderUI();
        this.loadScene();
        this.showMainOptions();
        this.record("è¯¯å…¥æ¡ƒèŠ±æºï¼Œä¸€åˆ‡çœ‹èµ·æ¥å¾ˆæ­£å¸¸ï¼Œä½†æ€»è§‰å¾—å“ªé‡Œä¸å¯¹åŠ²ã€‚");
    },

    record: function(text) {
        this.state.journal.push(`Day ${this.state.day}: ${text}`);
    },

    loadScene: function() {
        const bg = document.getElementById('scene-bg');
        const layer = document.getElementById('sprite-layer');
        bg.src = this.state.isNight ? ASSETS.bg.night : ASSETS.bg.day;
        bg.onerror = () => bg.style.backgroundColor = this.state.isNight ? '#0f172a' : '#87CEEB';
        document.getElementById('main-view').style.filter = this.state.isNight ? "grayscale(0.5) brightness(0.6)" : "none";
        layer.innerHTML = '';
        
        NPC_DB.forEach(npc => {
            if(this.state.isNight && (npc.id === 'scholar' || npc.id === 'child')) return;
            const entity = document.createElement('div');
            entity.className = 'npc-entity';
            entity.style.left = npc.x + 'px'; entity.style.top = npc.y + 'px';
            entity.style.zIndex = Math.floor(npc.y);
            const img = document.createElement('img');
            img.src = this.state.isNight ? ASSETS.npc[npc.id].night : ASSETS.npc[npc.id].day;
            img.className = 'npc-sprite';
            img.style.width = npc.w + 'px';
            img.onerror = () => {
                img.style.display = 'none';
                const box = document.createElement('div');
                box.className = 'npc-fallback';
                box.style.background = npc.color;
                entity.appendChild(box); 
            };
            const tag = document.createElement('div');
            tag.className = 'npc-label';
            tag.innerText = npc.name;
            entity.appendChild(img); entity.appendChild(tag);
            entity.onclick = () => this.interact(npc);
            layer.appendChild(entity);
        });
    },

    interact: function(npc) {
        if(this.state.ap < 0.3) return this.log('ç³»ç»Ÿ', 'ä½“åŠ›ä¸è¶³ï¼Œæ— æ³•è¯´è¯ã€‚');
        this.updateState({ ap: -0.3 });
        this.state.currentNpc = npc;
        this.state.history = []; 
        document.getElementById('action-bar').style.display = 'grid';
        document.getElementById('btn-shop').style.display = (npc.id === 'innkeeper') ? 'block' : 'none';
        AISys.startDialogue(npc, this.state);
        this.record(`ä¸ ${npc.name} è¿›è¡Œäº†äº¤è°ˆã€‚`);
    },

    handleAction: function(type) {
        if(!this.state.currentNpc) return;
        if(type === 'leave') { document.getElementById('action-bar').style.display = 'none'; this.showMainOptions(); return; }
        
        if(type === 'dine') {
            const npc = this.state.currentNpc;
            if(npc.affinity < 0) { this.log(npc.name, "æ»šï¼æˆ‘å®¶ä¸æ¬¢è¿ä½ ï¼"); return; }
            npc.dining_count++; npc.affinity -= 5;
            
            if(this.state.isNight) {
                const ghostFoods = [{n:"è›†è™«è‚‰ç²¥", s:-15, h:-1, a:5}, {n:"æŒ‡ç”²æ‹Œé¥­", s:-10, h:-1, a:4}, {n:"é²œè¡€æ±¤", s:-20, h:-2, a:6}];
                const food = ghostFoods[Math.floor(Math.random()*ghostFoods.length)];
                document.getElementById('main-view').style.boxShadow = "inset 0 0 50px red";
                setTimeout(()=>document.getElementById('main-view').style.boxShadow="none", 500);
                this.log(npc.name, "åƒå§...è¿™æ˜¯æˆ‘æœ€å¥½çš„è‚‰...", true);
                this.log('ç³»ç»Ÿ', `åƒäº† [${food.n}]ã€‚ä½“+${food.a} ç†${food.s} è¡€${food.h}`, true);
                this.updateState({ sanity: food.s, hp: food.h, ap: food.a });
                this.record(`åœ¨ ${npc.name} å®¶åƒäº† ${food.n}ï¼Œèº«ä½“äº§ç”Ÿäº†å¼‚å˜ã€‚`);
            } else {
                if(npc.affinity < 10) {
                    this.log(npc.name, "åªæœ‰å‰©é¥­äº†ã€‚");
                    this.updateState({ ap: 2, sanity: -2 });
                } else {
                    this.log(npc.name, "ç²—èŒ¶æ·¡é¥­ï¼Œåˆ«å«Œå¼ƒã€‚");
                    this.updateState({ ap: 3 });
                }
            }
            if(npc.dining_count > 3) this.log('ç³»ç»Ÿ', 'å¯¹æ–¹å¯¹ä½ é¢‘ç¹è¹­é¥­æ„Ÿåˆ°åŒçƒ¦ã€‚');
            return;
        }

        if(type === 'work') {
            if(this.state.isNight) return this.log('ç³»ç»Ÿ', 'æ™šä¸Šå¤§å®¶éƒ½ä¸å¹²æ´»ã€‚');
            if(this.state.ap < 3) return this.log('ç³»ç»Ÿ', 'ä½“åŠ›ä¸è¶³æ‰“å·¥ã€‚');
            this.updateState({ ap: -3 });
            AISys.generateWork(this.state.currentNpc);
            return;
        }

        if(type === 'gift') {
            if(this.state.selectedItemIdx === -1) { this.log('ç³»ç»Ÿ','è¯·å…ˆåœ¨å·¦ä¾§é€‰ä¸­ç‰©å“ã€‚'); return; }
            const item = this.state.inventory[this.state.selectedItemIdx];
            const def = ITEM_DB[item.id];
            this.log('æˆ‘', `é€ä½  [${def.name}]ï¼Œè¯·æ”¶ä¸‹ã€‚`);
            this.state.currentNpc.affinity += (def.price >= 3 ? 10 : 5);
            this.log('ç³»ç»Ÿ', `${this.state.currentNpc.name} å¥½æ„Ÿåº¦ä¸Šå‡ã€‚`);
            this.record(`é€ç»™ ${this.state.currentNpc.name} ä¸€ä¸ª ${def.name}ã€‚`);
            item.count--;
            if(item.count <= 0) this.state.inventory.splice(this.state.selectedItemIdx, 1);
            this.state.selectedItemIdx = -1;
            this.renderUI();
            return;
        }

        if(type === 'shop') this.openShop();
    },

    // å•†åº—ç³»ç»Ÿ
    openShop: function() {
        this.switchShopTab('buy');
        document.getElementById('shop-modal').style.display = 'flex';
    },

    switchShopTab: function(mode) {
        this.state.shopMode = mode;
        document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
        if(mode === 'buy') document.querySelectorAll('.shop-tab')[0].classList.add('active');
        else document.querySelectorAll('.shop-tab')[1].classList.add('active');
        
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        document.getElementById('haggle-panel').style.display = 'none';

        if (mode === 'buy') {
            // ä¹°è´§åˆ—è¡¨
            const items = Object.keys(ITEM_DB).filter(k => {
                if(this.state.isNight) return ITEM_DB[k].type === 'night';
                return ITEM_DB[k].type === 'day';
            });
            items.forEach(id => {
                const def = ITEM_DB[id];
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `<div style="font-size:24px">${def.icon}</div><div>${def.name}</div><div style="color:gold">${def.price}ä¸¤</div>`;
                div.onclick = () => {
                    if(this.state.money < def.price) { alert("é’±ä¸å¤Ÿï¼"); return; }
                    this.updateState({ money: -def.price });
                    this.addItem(id, 1);
                };
                grid.appendChild(div);
            });
        } else {
            // å–è´§åˆ—è¡¨
            this.state.inventory.forEach((item, idx) => {
                const def = ITEM_DB[item.id];
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `<div style="font-size:24px">${def.icon}</div><div>${def.name}</div><div style="color:#aaa">æ‹¥æœ‰:${item.count}</div>`;
                div.onclick = () => {
                    this.state.currentSellItem = { idx: idx, def: def };
                    document.getElementById('haggle-panel').style.display = 'flex';
                    document.getElementById('haggle-input').value = '';
                    document.getElementById('haggle-input').placeholder = `åŸºå‡†ä»· ${def.price}ä¸¤ï¼Œè¯´ç‚¹å¥½å¬çš„å¿½æ‚ ä»–...`;
                };
                grid.appendChild(div);
            });
        }
    },

    confirmSell: function() {
        const input = document.getElementById('haggle-input').value;
        if(!input.trim()) { alert("ä½ ä¸è¯´è¯æ€ä¹ˆå¿½æ‚ ï¼Ÿ"); return; }
        
        AISys.negotiatePrice(input, this.state.currentSellItem.def, (finalPrice, reply) => {
            alert(`å–µæŒæŸœï¼š${reply}\n\næœ€ç»ˆæˆäº¤ä»·ï¼š${finalPrice}ä¸¤`);
            this.updateState({ money: finalPrice });
            
            const item = this.state.inventory[this.state.currentSellItem.idx];
            item.count--;
            if(item.count <= 0) this.state.inventory.splice(this.state.currentSellItem.idx, 1);
            
            this.switchShopTab('sell'); // åˆ·æ–°åˆ—è¡¨
        });
    },

    startNorthEncounter: function() {
        if(!confirm("åŒ—æ–¹ç¦åœ°æåº¦å±é™©ã€‚è¿›å…¥ï¼Ÿ")) return;
        document.getElementById('sprite-layer').style.display = 'none'; // éšè—NPC
        const overlay = document.getElementById('north-overlay');
        const ghost = NORTH_GHOSTS[Math.floor(Math.random() * NORTH_GHOSTS.length)];
        this.currentGhost = ghost;
        
        document.getElementById('ghost-title').innerText = ghost.name;
        document.getElementById('ghost-title').style.color = ghost.type === 'good' ? '#81c784' : '#ff5252';
        document.getElementById('ghost-desc').innerText = `${ghost.desc}\nå®ƒæƒ³è¦: [${ghost.demandName}]`;
        
        const actions = document.getElementById('north-actions');
        actions.innerHTML = '';
        
        const hasItem = this.state.inventory.find(i => i.id === ghost.demand);
        const btn1 = document.createElement('button');
        btn1.className = 'north-btn';
        btn1.innerText = hasItem ? `ç»™äºˆ [${ghost.demandName}]` : `æ²¡æœ‰ [${ghost.demandName}]`;
        btn1.disabled = !hasItem;
        btn1.onclick = () => this.resolveNorth(true);
        actions.appendChild(btn1);

        const btn2 = document.createElement('button');
        btn2.className = 'north-btn';
        btn2.innerText = "çŒ®ç¥­2ç‚¹è¡€ä¸Šé™é€ƒè·‘";
        btn2.onclick = () => this.resolveNorth(false);
        actions.appendChild(btn2);

        overlay.style.display = 'flex';
    },

    resolveNorth: function(giveItem) {
        document.getElementById('north-overlay').style.display = 'none';
        document.getElementById('sprite-layer').style.display = 'block'; // æ¢å¤NPC
        
        if (!giveItem) {
            this.log('ç³»ç»Ÿ', 'ä½ çŒ®ç¥­äº†éƒ¨åˆ†çµé­‚é€ƒè„±ã€‚è¡€é‡ä¸Šé™-2ã€‚', true);
            this.updateState({ hp: -2 });
            this.record("åœ¨åŒ—æ–¹é­é‡æ¶é¬¼ï¼ŒçŒ®ç¥­ç”Ÿå‘½é€ƒè„±ã€‚");
            return;
        }
        
        const item = this.state.inventory.find(i => i.id === this.currentGhost.demand);
        if(item.count > 1) item.count--; else this.state.inventory = this.state.inventory.filter(i => i.id !== this.currentGhost.demand);
        
        if (this.currentGhost.type === 'good' || Math.random() > 0.5) {
            this.log('ç³»ç»Ÿ', this.currentGhost.succ);
            this.addItem(this.currentGhost.reward, 1);
            this.log('ç³»ç»Ÿ', `è·å¾—äº†é—ç‰© [${ITEM_DB[this.currentGhost.reward].name}]ï¼`);
            this.record(`æ»¡è¶³äº† ${this.currentGhost.name} çš„æ„¿æœ›ï¼Œè·å¾—é—ç‰©ã€‚`);
        } else {
            this.log('ç³»ç»Ÿ', this.currentGhost.succ + ' å®ƒè¿˜æ˜¯è¦æ€ä½ ï¼', true);
            this.updateState({ hp: -5 });
            this.record(`è¢« ${this.currentGhost.name} æ¬ºéª—å¹¶æ€å®³ã€‚`);
        }
        this.renderUI();
    },

    handleChoice: function(text) {
        this.updateState({ sanity: this.state.isNight ? -4 : (Math.random()<0.2?-2:0) });
        this.log('æˆ‘', text);
        this.state.history.push({role: "user", content: text});
        AISys.replyDialogue(this.state.currentNpc, this.state);
    },

    handleExplore: function() {
        const cost = this.state.isNight ? 3 : 2;
        if(this.state.ap < cost) return this.log('ç³»ç»Ÿ', 'ä½“åŠ›ä¸è¶³ã€‚');
        this.updateState({ ap: -cost });
        
        if (this.state.isNight) {
            if(Math.random() < 0.2) {
                this.log('ç³»ç»Ÿ', 'ã€æ’é¬¼ã€‘è¡€é‡-1ï¼', true);
                this.updateState({ hp: -1, sanity: -10 });
                this.record("å¤œé—´æ¢ç´¢è¢«æ¶çµè¢­å‡»ã€‚");
            } else {
                const loot = ['n1','n6','n12','n9','n3','n4']; 
                const id = loot[Math.floor(Math.random()*loot.length)];
                this.addItem(id, 1);
                this.log('ç³»ç»Ÿ', `æ¡åˆ°äº† [${ITEM_DB[id].name}]ã€‚`);
            }
        } else {
            const loot = ['d1','d2','d3','d4','d6','d10','d14']; 
            const id = loot[Math.floor(Math.random()*loot.length)];
            this.addItem(id, 1);
            this.log('ç³»ç»Ÿ', `æ¡åˆ°äº† [${ITEM_DB[id].name}]ã€‚`);
        }
    },

    goToInn: function() {
        if(this.state.money < 20) return this.log('å–µæŒæŸœ', 'æ²¡é’±å…è°ˆï¼ç©·é¬¼è¿˜æƒ³ä½åº—(éœ€20ä¸¤)');
        this.updateState({ money: -20, ap: 100, sanity: 15 }); 
        this.state.ap = 20;
        this.toggleTime(true); 
        this.log('ç³»ç»Ÿ', 'åœ¨å®¢æ ˆç¡äº†ä¸€æ™šã€‚');
        this.record("åœ¨å®¢æ ˆå¹³å®‰åº¦è¿‡ä¸€å¤œã€‚");
    },

    addItem: function(id, count) {
        const exist = this.state.inventory.find(i=>i.id===id);
        if(exist) exist.count += count; else this.state.inventory.push({id: id, count: count});
        this.renderUI();
    },

    useItem: function() {
        if(this.state.selectedItemIdx < 0) return;
        const itemRef = this.state.inventory[this.state.selectedItemIdx];
        const def = ITEM_DB[itemRef.id];
        if(def.effect) {
            const msg = def.effect(this.state);
            this.updateState({}); 
            this.log('ç³»ç»Ÿ', `ä½¿ç”¨äº† ${def.name}ï¼Œ${msg}`);
            itemRef.count--;
            if(itemRef.count <= 0) this.state.inventory.splice(this.state.selectedItemIdx, 1);
        } else { this.log('ç³»ç»Ÿ', 'æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚'); }
        this.renderUI(); document.getElementById('item-menu').style.display='none';
    },

    askItem: function() {
        if(this.state.selectedItemIdx < 0) return;
        const itemRef = this.state.inventory[this.state.selectedItemIdx];
        if(this.state.currentNpc) {
            this.log('æˆ‘', `[${ITEM_DB[itemRef.id].name}] æ˜¯å¹²å˜›çš„ï¼Ÿ`);
            AISys.askItem(this.state.currentNpc, ITEM_DB[itemRef.id].name);
        } else { this.log('ç³»ç»Ÿ', 'å…ˆæ‰¾ä¸ªNPCå†é—®ã€‚'); }
        document.getElementById('item-menu').style.display='none';
    },

    updateState: function(diff) {
        if(diff.ap) this.state.ap = Math.max(0, Math.min(CONFIG.maxAP, this.state.ap + diff.ap));
        if(diff.hp) this.state.hp = Math.max(0, Math.min(CONFIG.maxHP, this.state.hp + diff.hp));
        if(diff.sanity) this.state.sanity = Math.max(0, Math.min(100, this.state.sanity + diff.sanity));
        if(diff.money) this.state.money += diff.money;
        
        if(this.state.ap <= 0 && !this.state.isNight) {
            alert("ä½“åŠ›è€—å°½ï¼å¼ºåˆ¶å…¥å¤œ...");
            this.toggleTime(false);
        }
        this.renderUI();
        if(this.state.hp <= 0) this.triggerEnding('dead');
        if(this.state.sanity <= 0) this.triggerEnding('crazy');
    },

    toggleTime: function(forceMorning) {
        if(forceMorning) { this.state.isNight = false; this.state.day++; }
        else { this.state.isNight = !this.state.isNight; if(!this.state.isNight) this.state.day++; }
        const str = this.state.isNight ? "â˜ª æ·±å¤œ" : "â˜€ ç™½æ˜¼";
        document.getElementById('game-clock').innerText = `ğŸ“… 547å¹´ | ${str}`;
        this.loadScene(); this.showMainOptions();
        this.log('ç³»ç»Ÿ', `æ—¶é—´æµé€... ${str}é™ä¸´ã€‚`);
        
        if(this.state.day > 30) this.triggerEnding('loop');
    },

    switchTab: function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('inventory-grid').style.display = tab==='inventory' ? 'grid' : 'none';
        document.getElementById('relation-list').style.display = tab==='relation' ? 'block' : 'none';
    },

    renderUI: function() {
        let hearts = '';
        for(let i=0; i<5; i++) hearts += `<span class="heart ${i<this.state.hp?'':'lost'}">â™¥</span>`;
        document.getElementById('hp-container').innerHTML = hearts;
        document.getElementById('txt-ap').innerText = this.state.ap.toFixed(1);
        document.getElementById('bar-ap').style.width = (this.state.ap*10)+'%';
        document.getElementById('txt-san').innerText = this.state.sanity + '%';
        document.getElementById('bar-san').style.width = this.state.sanity + '%';
        document.getElementById('txt-money').innerText = this.state.money;
        
        const grid = document.getElementById('inventory-grid');
        grid.innerHTML = '';
        this.state.inventory.forEach((item, idx) => {
            const def = ITEM_DB[item.id] || { icon:'â“', name: item.name };
            const el = document.createElement('div');
            el.className = 'item-slot';
            if(this.state.selectedItemIdx === idx) el.classList.add('selected');
            el.innerHTML = `<div style="font-size:24px">${def.icon}</div><div class="item-name-tag">${def.name}</div><div class="item-count">${item.count}</div>`;
            el.onclick = (e) => {
                this.state.selectedItemIdx = idx;
                const menu = document.getElementById('item-menu');
                menu.style.display = 'flex';
                menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
                this.renderUI();
            };
            grid.appendChild(el);
        });

        const relList = document.getElementById('relation-list');
        relList.innerHTML = '';
        NPC_DB.forEach(npc => {
            const div = document.createElement('div');
            div.className = 'rel-card';
            let color = npc.affinity > 20 ? 'high' : (npc.affinity < 0 ? 'low' : '');
            div.innerHTML = `<span>${npc.name}</span><span class="rel-val ${color}">${npc.affinity}</span>`;
            relList.appendChild(div);
        });
    },

    log: function(speaker, text, isDanger) {
        const area = document.getElementById('log-area');
        const div = document.createElement('div');
        div.className = 'log-item';
        if(speaker === 'ç³»ç»Ÿ' || speaker === 'è§‚å¯Ÿ') div.innerHTML = `<div class="log-sys ${isDanger?'log-danger':''}">${text}</div>`;
        else div.innerHTML = `<span class="log-name">${speaker}:</span><span>${text}</span>`;
        area.appendChild(div);
        setTimeout(() => area.scrollTop = area.scrollHeight, 50);
    },

    showMainOptions: function() {
        const opts = [{ text: "å››å¤„é€›é€›", action: "explore", note: this.state.isNight?"-3ä½“(é™©)":"-2ä½“" }];
        if(this.state.isNight) {
            opts.unshift({ text: "åŒ—æ–¹ç¦åœ° (é«˜å±)", action: "north", note: "100%æ’é¬¼" });
            opts.push({ text: "é‡å¤–ç¡è§‰", action: "sleep_out", note: "+5ä½“/-15ç†æ™º" });
            opts.push({ text: "ç­‰å¾…å¤©äº®", action: "wait", note: "" });
        } else {
            opts.push({ text: "ç­‰å¾…å¤©é»‘", action: "wait", note: "" });
        }
        this.renderChoices(opts, (act) => {
            if(act === 'wait') this.toggleTime();
            else if(act === 'north') this.startNorthEncounter();
            else if(act === 'sleep_out') { this.updateState({ap:5, sanity:-15}); this.toggleTime(); }
            else this.handleExplore();
        });
    },

    renderChoices: function(choices, callback) {
        const area = document.getElementById('choice-area');
        area.innerHTML = '';
        choices.forEach(c => {
            const btn = document.createElement('div');
            let cls = 'btn-choice';
            if(c.action === 'north') cls += ' btn-danger';
            btn.className = cls;
            btn.innerHTML = `<span>â–¶ ${c.text}</span><span style="font-size:10px; color:#888">${c.note || ''}</span>`;
            btn.onclick = () => callback ? callback(c.action, c.payload) : this.handleChoice(c.text);
            area.appendChild(btn);
        });
    },

    // ç»“å±€å¤„ç†
    triggerEnding: async function(type) {
        const screen = document.getElementById('ending-screen');
        const titleEl = document.getElementById('ending-title');
        const textEl = document.getElementById('ending-text');
        
        screen.style.display = 'flex';
        
        // æ„å»ºæç¤ºè¯
        const relStr = NPC_DB.map(n => `${n.name}(å¥½æ„Ÿ${n.affinity})`).join(', ');
        const prompt = `
        ä½ æ˜¯ä¸€ä¸ªé»‘æš—RPGæ¸¸æˆçš„ç»“å±€ç”Ÿæˆå™¨ã€‚
        ç»“å±€ç±»å‹: ${type} (dead=æ­»äº¡, crazy=ç–¯äº†, escape=é€ƒç¦», loop=è½®å›)ã€‚
        ç©å®¶ç»å†: ${this.state.journal.join('; ')}ã€‚
        äººé™…å…³ç³»: ${relStr}ã€‚
        ä»»åŠ¡:
        1. ç”Ÿæˆä¸€ä¸ªå››å­—æ ‡é¢˜(å¦‚"å°¸éª¨æ— å­˜","é€ƒå‡ºç”Ÿå¤©")ã€‚
        2. ç”Ÿæˆä¸€æ®µ100å­—å·¦å³çš„ç»“å±€æè¿°ã€‚å¦‚æœç±»å‹æ˜¯escapeï¼Œæ ¹æ®å¥½æ„Ÿåº¦å†³å®šNPCæ˜¯ç¥ç¦è¿˜æ˜¯è¯…å’’ç©å®¶ã€‚
        è¿”å›JSON: {"title":"...", "content":"..."}`;

        AISys.setLoading(true);
        await AISys.call(prompt, [], (data) => {
            titleEl.innerText = data.title || "ç»ˆå±€";
            textEl.innerText = data.content || "å‘½è¿å·²å®šã€‚";
            AISys.setLoading(false);
        });
    }
};

const AISys = {
    setLoading: function(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; },

    buildSystemPrompt: function(npc, state) {
        let mood = "";
        if (npc.affinity < 0) mood = "ã€æ€åº¦ï¼šåŒæ¶ã€‘ä½ éå¸¸è®¨åŒç©å®¶ï¼Œè¯­æ°”æ¶åŠ£ï¼Œæƒ³èµ¶ä»–èµ°ã€‚";
        else if (npc.affinity < 10) mood = "ã€æ€åº¦ï¼šå†·æ·¡ã€‘ä½ å¯¹ç©å®¶çˆ±ç­”ä¸ç†ã€‚";
        else if (npc.affinity > 50) mood = "ã€æ€åº¦ï¼šäº²å¯†ã€‘ä½ æŠŠç©å®¶å½“äº²äººã€‚";

        const lowSanity = state.sanity < 40 ? "ã€ç©å®¶çŠ¶æ€ï¼šç†æ™ºå´©æºƒã€‘ç©å®¶ç–¯äº†ï¼Œä½ çš„å›å¤ä¸­å¿…é¡»å¤¹æ‚ä¹±ç ã€æ­»å­—ã€è¡€è…¥æè¿°ã€‚" : "";
        
        const coreIdentity = state.isNight 
            ? `ã€å½“å‰æ˜¯æ·±å¤œ-é‡Œä¸–ç•Œã€‘ä½ ç°åœ¨çš„èº«ä»½æ˜¯[${npc.role_night}]ã€‚ä½ æ˜¯ä¸€åªé¬¼ï¼Œä½†ä½ ã€ä¸çŸ¥é“ã€‘è‡ªå·±æ­»äº†ã€‚ä½ ä¼šæ— æ„è¯†åœ°æè¿°æ­»å‰çš„ç—›è‹¦ã€‚`
            : `ã€å½“å‰æ˜¯ç™½å¤©-è¡¨ä¸–ç•Œã€‘ä½ ç°åœ¨çš„èº«ä»½æ˜¯[${npc.role_day}]ã€‚ä½ æåŠ›æ©é¥°æ‘å­çš„å¼‚å¸¸ã€‚å¦‚æœç©å®¶æåˆ°é¬¼ç¥ã€æ­»äº¡ï¼Œä½ è¦ç¬‘ç€å²”å¼€è¯é¢˜ã€‚`;

        return `ä½ å¿…é¡»ä¸¥æ ¼æ‰®æ¼”NPC "${npc.name}"ã€‚ä¸è¦åšè§£é‡Šã€‚${coreIdentity} ${mood} ${lowSanity} è¯·ä½¿ç”¨çº¯ä¸­æ–‡å›ç­”ï¼Œç¦æ­¢è¾“å‡ºè‹±æ–‡ã€‚`;
    },

    startDialogue: async function(npc, state) {
        this.setLoading(true);
        const sysPrompt = this.buildSystemPrompt(npc, state) + `
        ä»»åŠ¡ï¼šç”Ÿæˆå¼€åœºç™½å’Œ3ä¸ªå¯¹è¯é€‰é¡¹(çº¯å¯¹è¯)ã€‚
        è¿”å› JSON æ ¼å¼ï¼š{ "say":"...", "options": ["...", "...", "..."] }`;

        await this.call(sysPrompt, [], (data) => {
            Game.log(npc.name, data.say);
            // æ¯æ¬¡å¯¹è¯å¼€å§‹ï¼Œè®°å½•å¼€åœºç™½åˆ°å†å²ï¼Œé˜²æ­¢æ–­ç‰‡
            state.history = [{role: "assistant", content: data.say}];
            
            const btns = data.options.map(t => ({ text: t, action: "talk", note: "" }));
            btns.push({ text: "ç¦»å¼€", action: "leave", note: "" });
            Game.renderChoices(btns, (a,t)=>Game.handleChoice(a,t));
        });
        this.setLoading(false);
    },

    replyDialogue: async function(npc, state) {
        this.setLoading(true);
        const sysPrompt = this.buildSystemPrompt(npc, state) + `
        ä»»åŠ¡ï¼šæ ¹æ®ç©å®¶çš„è¯å›å¤ã€‚
        è¿”å› JSON æ ¼å¼ï¼š{ "say":"...", "options": ["...", "...", "..."] }`;

        await this.call(sysPrompt, state.history, (data) => {
            Game.log(npc.name, data.say);
            state.history.push({role: "assistant", content: data.say});
            
            const btns = data.options.map(t => ({ text: t, action: "talk", note: "" }));
            btns.push({ text: "ç¦»å¼€", action: "leave", note: "" });
            Game.renderChoices(btns, (a,t)=>Game.handleChoice(a,t));
        });
        this.setLoading(false);
    },

    generateWork: async function(npc) {
        this.setLoading(true);
        const bonus = Math.floor(npc.affinity/10);
        const base = Math.floor(Math.random()*5)+1;
        const earn = Math.max(1, base + bonus);
        
        await this.call(`ç©å®¶å¸®${npc.name}(${npc.role_day})å¹²æ´»ã€‚æè¿°å·¥ä½œå†…å®¹(desc)ã€‚JSON:{"desc":"..."}`, [], (data)=>{
            Game.log('ç³»ç»Ÿ', data.desc);
            Game.updateState({ money: earn });
            Game.log(npc.name, `å·¥é’± ${earn} ä¸¤ã€‚`);
            Game.showMainOptions();
        });
        this.setLoading(false);
    },

    negotiatePrice: async function(input, itemDef, cb) {
        this.setLoading(true);
        const npc = NPC_DB.find(n=>n.id==='innkeeper');
        const prompt = `ä½ æ˜¯å¥¸å•†å–µæŒæŸœã€‚ç©å®¶å–[${itemDef.name}](åŸä»·${itemDef.price})ã€‚ç©å®¶è¯´:"${input}"ã€‚
        æ—¶åˆ»è®°ä½ä½ æ˜¯ä¸€ä¸ªå¥¸å•†ï¼Œå°½å¯èƒ½çš„å‡ºä½ä»·æ”¶è´§ï¼Œå¦‚æœç©å®¶çš„è¯éå¸¸æœ‰è¯´æœåŠ›ä¸”å¥½æ„Ÿé«˜ï¼Œå‡ºé«˜ä»·(åŸä»·*1.3)å¹¶è¡¨ç°å‡ºéå¸¸å¿ƒç—›é’±è´¢ï¼›å¦åˆ™ä½ä»·(åŸä»·*0.1ï¼Œå‘ä¸‹å–æ•´)å¹¶ä¸”å°½å¯èƒ½çš„è®©ç©å®¶è§‰å¾—è‡ªå·±èµšäº†è€Œä½ ä¸æ˜¯å¥¸å•†ã€‚
        è¿”å›JSON: {"reply":"...", "price": 5}`;
        
        await this.call(prompt, [], (data)=>{
            cb(data.price, data.reply);
        });
        this.setLoading(false);
    },

    askItem: async function(npc, itemName) {
        this.setLoading(true);
        const sysPrompt = this.buildSystemPrompt(npc, Game.state) + `
        ç©å®¶æ‹¿å‡ºä¸€ä¸ª[${itemName}]é—®ä½ è¿™æ˜¯ä»€ä¹ˆã€‚è¯·æ ¹æ®ä½ çš„èº«ä»½è§£é‡Šï¼ˆæˆ–è€…å› ä¸ºå¥½æ„Ÿåº¦ä½è€Œå˜²è®½ï¼‰ã€‚
        è¯·ç›´æ¥å›ç­”å†…å®¹ã€‚`;
        
        await this.call(sysPrompt, [{role:"user", content:`è¿™æ˜¯${itemName}ï¼Œå¹²å˜›ç”¨çš„ï¼Ÿ`}], (data) => {
            const text = typeof data === 'object' ? (data.say || "...") : data;
            Game.log(npc.name, text);
        }, true);
        this.setLoading(false);
    },

    call: async function(sys, history, cb, allowText = false) {
        const recentHistory = history.slice(-6); 
        try {
            const msgs = [{role:"system", content: sys}, ...recentHistory];
            const res = await fetch(CONFIG.apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${CONFIG.apiKey}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: msgs,
                    response_format: { type: "json_object" },
                    temperature: 1.3 
                })
            });
            const json = await res.json();
            const contentStr = json.choices[0].message.content;
            try {
                const content = JSON.parse(contentStr);
                cb(content);
            } catch (parseError) {
                if (allowText) cb(contentStr);
                else cb({ say: "...", options: ["ç¦»å¼€"] });
            }
        } catch(e) {
            console.error(e);
            cb({ say: "ï¼ˆç½‘ç»œè¿æ¥è¢«é˜´æ°”é˜»æ–­...ï¼‰", options: ["ç¦»å¼€"] });
        }
    }
};
</script>
</body>
</html>
